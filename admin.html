<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Absensi - iâ€‘Absensi</title>
  <style>
    /* Styles (sesuai sebelumnya) */
    /* spinner, sidebar, table, dll... */
  </style>
</head>
<body>
  <div id="loadingSpinner" class="spinner"></div>

  <!-- Sidebar untuk filter -->
  <div class="sidebar">
    <button onclick="location.href='dashboard.html'">Dashboard</button>
    <h3>Filter</h3>
    <select id="filterTipe">
      <option value="">Semua Tipe</option>
      <option value="Masuk">Masuk</option>
      <option value="Pulang">Pulang</option>
    </select>
    <select id="filterNama">
      <option value="">Semua Nama</option>
    </select>
  </div>

  <div>
    <h2>Data Absensi</h2>
    <div class="controls">
      <input type="date" id="startDate">
      <input type="date" id="endDate">
      <button id="filterBtn">Filter</button>
      <button id="resetBtn">Reset</button>
    </div>
    <div class="table-container">
      <table id="absenTable">
        <thead>
          <tr>
            <th>Timestamp</th><th>Nama</th><th>Lokasi</th><th>Foto</th><th>Tipe</th>
          </tr>
        </thead>
        <tbody id="absenBody"></tbody>
      </table>
    </div>
  </div>

<script src="config.js"></script>
<script>
if (localStorage.getItem('loggedIn')!=='true') window.location='login.html';

const endpointMasuk = API_ENDPOINT+'?action=get&sheet=Sheet1';
const endpointPulang = API_ENDPOINT+'?action=get&sheet=Sheet2';
const endpointNama = API_ENDPOINT+'?action=nama';

let allData = [], filterNama='', filterTipe='', startDate='', endDate='';

// Load semua data
async function loadAll() {
  document.getElementById('loadingSpinner').style.display='block';
  try {
    const m = await fetch(endpointMasuk).then(r=>r.json());
    const p = await fetch(endpointPulang).then(r=>r.json());
    const n = await fetch(endpointNama).then(r=>r.json());

    allData = [
      ...m.map(d=>({...d, tipe:'Masuk'})),
      ...p.map(d=>({...d, tipe:'Pulang'}))
    ];
    renderNamaFilter(n);
    applyFilters();
  } catch(e) {
    console.error(e);
  } finally {
    document.getElementById('loadingSpinner').style.display='none';
  }
}

// Render nama dropdown
function renderNamaFilter(listNama) {
  const sel = document.getElementById('filterNama');
  listNama.forEach(n => {
    const o = document.createElement('option');
    o.value = o.textContent = n;
    sel.appendChild(o);
  });
}

// Filter data dan render tabel
function applyFilters(){
  let data = [...allData];

  if (startDate && endDate) {
    const s = new Date(startDate),
          e = new Date(endDate);
    e.setHours(23,59,59,999);
    data = data.filter(d=>{
      const t=new Date(d.timestamp);
      return t>=s && t<=e;
    });
  }
  if (filterNama) data = data.filter(d=>d.nama===filterNama);
  if (filterTipe) data = data.filter(d=>d.tipe===filterTipe);

  renderTable(data);
}

// Show data di tabel
function renderTable(data){
  const body=document.getElementById('absenBody');
  body.innerHTML='';
  if (!data.length) {
    body.innerHTML='<tr><td colspan="5">Tidak ada data</td></tr>';
    return;
  }
  data.forEach(d=>{
    const img=`<a href="${d.linkfoto}" target="_blank">
      <img src="https://drive.google.com/thumbnail?id=${extractId(d.linkfoto)}&sz=w150">
    </a>`;
    body.innerHTML+=`<tr>
      <td>${formatDate(d.timestamp)}</td>
      <td>${d.nama}</td>
      <td><a href="${d.lokasi}" target="_blank">Link</a></td>
      <td>${img}</td>
      <td>${d.tipe}</td>
    </tr>`;
  });
}

// Utility
function extractId(url){
  const m=url.match(/\/d\/([^\/]+)/);
  return m?m[1]:'';
}
function formatDate(s){
  const d=new Date(s), pad=n=>('0'+n).slice(-2);
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

// Event
document.getElementById('filterTipe').onchange=e=>{
  filterTipe=e.target.value; applyFilters();
};
document.getElementById('filterNama').onchange=e=>{
  filterNama=e.target.value; applyFilters();
};
document.getElementById('filterBtn').onclick=()=>{
  startDate=document.getElementById('startDate').value;
  endDate=document.getElementById('endDate').value;
  applyFilters();
};
document.getElementById('resetBtn').onclick=()=>{
  filterNama=filterTipe=startDate=endDate='';
  document.getElementById('filterNama').value='';
  document.getElementById('filterTipe').value='';
  document.getElementById('startDate').value='';
  document.getElementById('endDate').value='';
  applyFilters();
};

loadAll();
setTimeout(()=>localStorage.removeItem('loggedIn'),300000);
</script>
</body>
</html>
