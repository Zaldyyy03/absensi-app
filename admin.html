<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Data Absensi</title>
  <link rel="icon" href="pertamina-logoicon.png" />
  <style>
    /* Gaya CSS tetap seperti sebelumnya (tidak diubah) */
  </style>
</head>
<body>
  <div class="container">
    <a class="dashboard-button" href="dashboard.html">‚Üê Dashboard</a>
    <div class="header">
      <h2>Data Absensi Karyawan</h2>
    </div>

    <div class="filters">
      <label for="filter-tanggal">Tanggal:</label>
      <input type="date" id="filter-tanggal">

      <label for="filter-absen">Tipe Absen:</label>
      <select id="filter-absen">
        <option value="">Semua</option>
        <option value="Masuk">Absen Masuk</option>
        <option value="Pulang">Absen Pulang</option>
      </select>

      <button onclick="renderTable()">Terapkan Filter</button>
      <button onclick="exportExcel()">Export Excel</button>
      <button onclick="exportPDF()">Export PDF</button>
    </div>

    <table id="absensi-table">
      <thead>
        <tr>
          <th>No</th>
          <th>Nama</th>
          <th>Tanggal & Jam</th>
          <th>Lokasi</th>
          <th>Foto</th>
          <th>Tipe Absen</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="config.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script>
    if (localStorage.getItem('loggedIn') !== 'true') {
      window.location.href = 'login.html';
    }

    const tableBody = document.querySelector("#absensi-table tbody");
    const filterTanggal = document.getElementById("filter-tanggal");
    const filterAbsen = document.getElementById("filter-absen");

    const endpointMasuk  = API_ENDPOINT + '?action=get&sheet=Sheet1';
    const endpointPulang = API_ENDPOINT + '?action=get&sheet=Sheet2';

    function formatInputDate(str) {
      const d = new Date(str);
      return isNaN(d) ? '' : d.toISOString().split("T")[0];
    }

    function getDriveThumbnail(url) {
      const match = url.match(/\/d\/(.+?)\//);
      const id = match ? match[1] : '';
      return id ? `https://drive.google.com/thumbnail?id=${id}&sz=w150` : '';
    }

    async function fetchData() {
      try {
        const [resMasuk, resPulang] = await Promise.all([
          fetch(endpointMasuk).then(r => r.json()),
          fetch(endpointPulang).then(r => r.json())
        ]);
        const masuk  = (resMasuk.data || []).map(d => ({ ...d, tipe: "Masuk" }));
        const pulang = (resPulang.data || []).map(d => ({ ...d, tipe: "Pulang" }));
        return [...masuk, ...pulang];
      } catch (e) {
        console.error("Gagal ambil data:", e);
        return [];
      }
    }

    async function renderTable() {
      const data = await fetchData();
      const tgl = filterTanggal.value;
      const tipe = filterAbsen.value;
      tableBody.innerHTML = "";

      data
        .filter(row => {
          const tglRow = formatInputDate(row.timestamp);
          const matchTgl = !tgl || tglRow === tgl;
          const matchTipe = !tipe || row.tipe === tipe;
          return matchTgl && matchTipe;
        })
        .forEach((row, i) => {
          const foto = row.linkfoto && row.linkfoto.includes("http")
            ? `<a href="${row.linkfoto}" target="_blank">
                <img class="foto-preview" src="${getDriveThumbnail(row.linkfoto)}" alt="foto">
              </a>` : 'Tidak ada';

          const tr = `
            <tr>
              <td>${i + 1}</td>
              <td>${row.nama || '-'}</td>
              <td>${row.timestamp || '-'}</td>
              <td><a href="${row.lokasi}" target="_blank">Lihat Lokasi</a></td>
              <td>${foto}</td>
              <td>${row.tipe}</td>
            </tr>
          `;
          tableBody.insertAdjacentHTML('beforeend', tr);
        });
    }

    function exportExcel() {
      const wb = XLSX.utils.book_new();
      const data = Array.from(tableBody.children).map(r => [
        r.children[0].textContent,
        r.children[1].textContent,
        r.children[2].textContent,
        r.children[3].textContent,
        r.children[5].textContent
      ]);
      const ws = XLSX.utils.aoa_to_sheet([
        ["Laporan Absensi"], [],
        ["No", "Nama", "Tanggal & Jam", "Lokasi", "Tipe Absen"],
        ...data
      ]);
      XLSX.utils.book_append_sheet(wb, ws, "Absensi");
      XLSX.writeFile(wb, `Absensi_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("Laporan Absensi", 20, 20);
      doc.setFontSize(10);
      let y = 30;

      Array.from(tableBody.children).forEach((r, i) => {
        const nama = r.children[1].textContent;
        const tgljam = r.children[2].textContent;
        const tipe = r.children[5].textContent;
        doc.text(`${i + 1}. ${nama} | ${tgljam} | ${tipe}`, 20, y);
        y += 6;
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
      });

      doc.save(`Absensi_${new Date().toISOString().split("T")[0]}.pdf`);
    }

    filterTanggal.addEventListener("change", renderTable);
    filterAbsen.addEventListener("change", renderTable);
    window.addEventListener("load", renderTable);
    setTimeout(() => localStorage.removeItem('loggedIn'), 3600000); // 1 jam auto logout
  </script>
</body>
</html>
